<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Гонки на двоих</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #1a2a6c, #9b59b6);
            font-family: Arial, sans-serif;
            color: white;
            overflow: hidden;
        }
        
        .game-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }
        
        .race-info {
            display: flex;
            gap: 50px;
            font-size: 1.2rem;
            margin-bottom: 10px;
        }
        
        .player-info {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }
        
        #gameCanvas {
            border: 3px solid white;
            border-radius: 10px;
            background: #2c3e50;
        }
        
        .controls {
            text-align: center;
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin-top: 10px;
        }
        
        .back-btn {
            padding: 10px 20px;
            background: #ff4757;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 15px;
            text-decoration: none;
            display: inline-block;
        }
        
        .lap-counter {
            font-size: 1.5rem;
            margin-top: 10px;
        }
        
        .start-message {
            color: #ffeb3b;
            font-size: 1.2rem;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <h1>Гонки на двоих</h1>
        
        <div class="lap-counter">Круг: <span id="lapCount">1</span>/3</div>
        
        <div class="race-info">
            <div class="player-info">
                <div>Игрок 1 (Красный)</div>
                <div>Скорость: <span id="speed1">0</span> км/ч</div>
                <div>Позиция: <span id="position1">-</span></div>
            </div>
            <div class="player-info">
                <div>Игрок 2 (Синий)</div>
                <div>Скорость: <span id="speed2">0</span> км/ч</div>
                <div>Позиция: <span id="position2">-</span></div>
            </div>
        </div>
        
        <canvas id="gameCanvas" width="800" height="600"></canvas>
        
        <div class="start-message" id="startMessage">Нажми SPACE для начала игры!</div>
        
        <div class="controls">
            <p><strong>Управление:</strong></p>
            <p>Игрок 1: WASD (движение)</p>
            <p>Игрок 2: Стрелки (движение)</p>
            <p>SPACE - пауза | R - перезапуск</p>
        </div>
        
        <a href="../index.html" class="back-btn">← Назад к играм</a>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        // Элементы интерфейса
        const speed1Element = document.getElementById('speed1');
        const speed2Element = document.getElementById('speed2');
        const position1Element = document.getElementById('position1');
        const position2Element = document.getElementById('position2');
        const lapCountElement = document.getElementById('lapCount');
        const startMessage = document.getElementById('startMessage');

        // Игровые константы
        const CAR_WIDTH = 30;
        const CAR_HEIGHT = 50;
        const MAX_SPEED = 5;
        const ACCELERATION = 0.1;
        const FRICTION = 0.05;
        const ROTATION_SPEED = 0.03;

        // Трасса (упрощенная овальная)
        const track = {
            outer: [
                {x: 100, y: 100}, {x: 700, y: 100},
                {x: 700, y: 500}, {x: 100, y: 500}
            ],
            inner: [
                {x: 200, y: 200}, {x: 600, y: 200},
                {x: 600, y: 400}, {x: 200, y: 400}
            ]
        };

        // Машины
        const car1 = {
            x: 150,
            y: 300,
            width: CAR_WIDTH,
            height: CAR_HEIGHT,
            speed: 0,
            angle: 0,
            color: '#e74c3c',
            lap: 0,
            checkpoints: 0,
            finished: false
        };

        const car2 = {
            x: 250,
            y: 300,
            width: CAR_WIDTH,
            height: CAR_HEIGHT,
            speed: 0,
            angle: 0,
            color: '#3498db',
            lap: 0,
            checkpoints: 0,
            finished: false
        };

        let currentLap = 1;
        const totalLaps = 3;
        let gameRunning = false;
        let gamePaused = false;
        let raceFinished = false;

        // Ключи управления
        const keys = {};

        // Стартовая линия
        const startLine = { x1: 150, y1: 250, x2: 250, y2: 350 };

        function gameLoop() {
            if (!gameRunning || gamePaused) return;
            
            update();
            draw();
            requestAnimationFrame(gameLoop);
        }

        function update() {
            // Управление машинами
            updateCar(car1, 'w', 'a', 's', 'd');
            updateCar(car2, 'ArrowUp', 'ArrowLeft', 'ArrowDown', 'ArrowRight');
            
            // Проверка чекпоинтов
            checkCheckpoints(car1);
            checkCheckpoints(car2);
            
            // Обновление интерфейса
            updateInterface();
            
            // Проверка завершения гонки
            if (car1.lap > totalLaps || car2.lap > totalLaps) {
                finishRace();
            }
        }

        function updateCar(car, up, left, down, right) {
            if (car.finished) return;
            
            // Ускорение
            if (keys[up]) {
                car.speed += ACCELERATION;
            } else if (keys[down]) {
                car.speed -= ACCELERATION;
            } else {
                // Трение
                car.speed *= (1 - FRICTION);
            }
            
            // Ограничение скорости
            car.speed = Math.max(-MAX_SPEED / 2, Math.min(MAX_SPEED, car.speed));
            
            // Поворот
            if (Math.abs(car.speed) > 0.1) {
                if (keys[left]) {
                    car.angle -= ROTATION_SPEED * (car.speed / MAX_SPEED);
                }
                if (keys[right]) {
                    car.angle += ROTATION_SPEED * (car.speed / MAX_SPEED);
                }
            }
            
            // Движение
            const newX = car.x + Math.sin(car.angle) * car.speed;
            const newY = car.y - Math.cos(car.angle) * car.speed;
            
            // Проверка столкновения с границами
            if (isOnTrack(newX, newY)) {
                car.x = newX;
                car.y = newY;
            } else {
                car.speed *= 0.5; // Замедление при столкновении
            }
        }

        function isOnTrack(x, y) {
            // Проверка, что точка находится между внешней и внутренней границами
            return isPointInPolygon(x, y, track.outer) && !isPointInPolygon(x, y, track.inner);
        }

        function isPointInPolygon(x, y, polygon) {
            let inside = false;
            for (let i = 0, j = polygon.length - 1; i < polygon.length; j = i++) {
                const xi = polygon[i].x, yi = polygon[i].y;
                const xj = polygon[j].x, yj = polygon[j].y;
                
                const intersect = ((yi > y) != (yj > y))
                    && (x < (xj - xi) * (y - yi) / (yj - yi) + xi);
                if (intersect) inside = !inside;
            }
            return inside;
        }

        function checkCheckpoints(car) {
            // Проверка пересечения стартовой линии
            if (car.x > startLine.x1 && car.x < startLine.x2 && 
                car.y > startLine.y1 && car.y < startLine.y2) {
                if (car.checkpoints === 4) {
                    car.lap++;
                    car.checkpoints = 0;
                    currentLap = Math.max(currentLap, car.lap);
                    lapCountElement.textContent = currentLap;
                }
            }
            
            // Упрощенные чекпоинты (углы трассы)
            const checkpoints = [
                {x: 700, y: 100}, {x: 700, y: 500}, 
                {x: 100, y: 500}, {x: 100, y: 100}
            ];
            
            for (let i = 0; i < checkpoints.length; i++) {
                const cp = checkpoints[i];
                const distance = Math.sqrt((car.x - cp.x) ** 2 + (car.y - cp.y) ** 2);
                
                if (distance < 50 && car.checkpoints === i) {
                    car.checkpoints++;
                    break;
                }
            }
        }

        function updateInterface() {
            speed1Element.textContent = Math.abs(Math.round(car1.speed * 50));
            speed2Element.textContent = Math.abs(Math.round(car2.speed * 50));
            
            // Определение позиции по прогрессу
            const progress1 = car1.lap * 1000 + car1.checkpoints * 250 + getDistanceToNextCheckpoint(car1);
            const progress2 = car2.lap * 1000 + car2.checkpoints * 250 + getDistanceToNextCheckpoint(car2);
            
            if (progress1 > progress2) {
                position1Element.textContent = "1-й";
                position2Element.textContent = "2-й";
            } else {
                position1Element.textContent = "2-й";
                position2Element.textContent = "1-й";
            }
        }

        function getDistanceToNextCheckpoint(car) {
            const checkpoints = [
                {x: 700, y: 100}, {x: 700, y: 500}, 
                {x: 100, y: 500}, {x: 100, y: 100}
            ];
            const nextCP = checkpoints[car.checkpoints % 4];
            return 250 - Math.min(250, Math.sqrt((car.x - nextCP.x) ** 2 + (car.y - nextCP.y) ** 2));
        }

        function finishRace() {
            raceFinished = true;
            gameRunning = false;
            
            let winner = '';
            if (car1.lap > car2.lap) {
                winner = "Победил Игрок 1!";
            } else if (car2.lap > car1.lap) {
                winner = "Победил Игрок 2!";
            } else {
                const progress1 = car1.checkpoints * 250 + getDistanceToNextCheckpoint(car1);
                const progress2 = car2.checkpoints * 250 + getDistanceToNextCheckpoint(car2);
                winner = progress1 > progress2 ? "Победил Игрок 1!" : "Победил Игрок 2!";
            }
            
            ctx.fillStyle = 'rgba(0, 0, 0, 0.8)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            ctx.fillStyle = 'white';
            ctx.font = '40px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(winner, canvas.width / 2, canvas.height / 2 - 30);
            ctx.font = '20px Arial';
            ctx.fillText('Нажми SPACE для новой гонки', canvas.width / 2, canvas.height / 2 + 30);
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Рисуем траву
            ctx.fillStyle = '#27ae60';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Рисуем дорогу
            ctx.fillStyle = '#7f8c8d';
            ctx.beginPath();
            ctx.moveTo(track.outer[0].x, track.outer[0].y);
            for (let i = 1; i < track.outer.length; i++) {
                ctx.lineTo(track.outer[i].x, track.outer[i].y);
            }
            ctx.closePath();
            ctx.fill();
            
            // Вырезаем внутреннюю часть
            ctx.fillStyle = '#27ae60';
            ctx.beginPath();
            ctx.moveTo(track.inner[0].x, track.inner[0].y);
            for (let i = 1; i < track.inner.length; i++) {
                ctx.lineTo(track.inner[i].x, track.inner[i].y);
            }
            ctx.closePath();
            ctx.fill();
            
            // Рисуем разметку
            ctx.strokeStyle = 'white';
            ctx.setLineDash([10, 10]);
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(400, 100);
            ctx.lineTo(400, 500);
            ctx.stroke();
            ctx.setLineDash([]);
            
            // Рисуем стартовую линию
            ctx.strokeStyle = 'white';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(startLine.x1, startLine.y1);
            ctx.lineTo(startLine.x2, startLine.y2);
            ctx.stroke();
            
            // Рисуем машины
            drawCar(car1);
            drawCar(car2);
            
            // Сообщение о начале
            if (!gameRunning && !raceFinished) {
                ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                ctx.fillStyle = 'white';
                ctx.font = '30px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('Нажми SPACE для начала', canvas.width / 2, canvas.height / 2);
            }
        }

        function drawCar(car) {
            ctx.save();
            ctx.translate(car.x, car.y);
            ctx.rotate(car.angle);
            
            // Корпус
            ctx.fillStyle = car.color;
            ctx.fillRect(-car.width / 2, -car.height / 2, car.width, car.height);
            
            // Полосы на крыше
            ctx.fillStyle = '#2c3e50';
            ctx.fillRect(-car.width / 2 + 5, -car.height / 2 + 5, car.width - 10, 10);
            
            // Фары
            ctx.fillStyle = '#f1c40f';
            ctx.fillRect(-car.width / 2 + 2, -car.height / 2 + 2, 4, 4);
            ctx.fillRect(-car.width / 2 + 2, car.height / 2 - 6, 4, 4);
            ctx.fillRect(car.width / 2 - 6, -car.height / 2 + 2, 4, 4);
            ctx.fillRect(car.width / 2 - 6, car.height / 2 - 6, 4, 4);
            
            ctx.restore();
        }

        // Обработка управления
        document.addEventListener('keydown', (e) => {
            const gameKeys = [' ', 'r', 'w', 'a', 's', 'd', 
                            'ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'];
            
            if (gameKeys.includes(e.key)) {
                e.preventDefault();
            }
            
            keys[e.key] = true;
            
            if (e.key === ' ' && !gameRunning && !raceFinished) {
                startGame();
            } else if (e.key === ' ' && gameRunning) {
                gamePaused = !gamePaused;
                if (!gamePaused) {
                    gameLoop();
                }
            }
            
            if (e.key === ' ' && raceFinished) {
                resetGame();
            }
            
            if (e.key === 'r') {
                resetGame();
            }
        });

        document.addEventListener('keyup', (e) => {
            if (['w', 'a', 's', 'd', 
                'ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(e.key)) {
                e.preventDefault();
            }
            keys[e.key] = false;
        });

        function startGame() {
            gameRunning = true;
            raceFinished = false;
            startMessage.style.display = 'none';
            gameLoop();
        }

        function resetGame() {
            car1.x = 150;
            car1.y = 300;
            car1.speed = 0;
            car1.angle = 0;
            car1.lap = 0;
            car1.checkpoints = 0;
            car1.finished = false;
            
            car2.x = 250;
            car2.y = 300;
            car2.speed = 0;
            car2.angle = 0;
            car2.lap = 0;
            car2.checkpoints = 0;
            car2.finished = false;
            
            currentLap = 1;
            lapCountElement.textContent = '1';
            raceFinished = false;
            gameRunning = false;
            gamePaused = false;
            startMessage.style.display = 'block';
            draw();
        }

        // Инициализация
        draw();
    </script>
</body>
</html>